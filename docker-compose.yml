# version: '3'

# services:
#   init-data:
#     image: busybox
#     command: chmod -R 777 /data
#     volumes:
#       - ./data:/data

#   surrealdb:
#     image: surrealdb/surrealdb:latest
#     container_name: surrealdb
#     restart: always
#     command: start --user ${SURREAL_ADMIN} --pass ${SURREAL_PASS} file:/data/database.db
#     ports:
#       - 8000:8000
#     volumes:
#       - ./data:/data
#     depends_on:
#       init-data:
#         condition: service_completed_successfully
#     networks:
#       - purrimeter-internal
#     ulimits:
#       nproc: 65535
#       nofile:
#         soft: 65535
#         hard: 65535
#       memlock:
#         soft: -1
#         hard: -1

#   api:
#     build:
#       context: ./api
#       dockerfile: Dockerfile
#     restart: always
#     ports:
#       - "8080:8080"
#     networks:
#       - purrimeter-internal
#     environment:
#       - API_ADMIN=${API_ADMIN}
#       - SURREAL_ADMIN=${SURREAL_ADMIN}
#       - SURREAL_PASS=${SURREAL_PASS}
#       - API_ADMIN_PASS=${API_ADMIN_PASS}
#       - LOGGER_USER=${LOGGER_USER}
#       - LOGGER_PASS=${LOGGER_PASS}
#       - JWT_SECRET=${JWT_SECRET}
#       - AGENT_SECRET=${AGENT_SECRET}
#     depends_on:
#       surrealdb:
#         condition: service_started
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
#       interval: 5s
#       timeout: 2s
#       retries: 2
#       start_period: 20s
#     ulimits:
#       nproc: 65535
#       nofile:
#         soft: 65535
#         hard: 65535
#       memlock:
#         soft: -1
#         hard: -1




# networks:
#   purrimeter-internal:
#     driver: bridge
#     name: "purrimeter-internal"
#     driver_opts:
#       com.docker.network.bridge.name: purrimeter0
#       com.docker.network.driver.mtu: 1500

# # volumes:
# #   surrealdb-data:


version: '3'

services:
  init-data:
    image: busybox
    command: chmod -R 777 /data
    volumes:
      - ./data:/data

  surrealdb:
    image: surrealdb/surrealdb:latest
    container_name: surrealdb
    restart: always
    command: start --user ${SURREAL_ADMIN} --pass ${SURREAL_PASS} rocksdb://data/database.db
    ports:
      - 127.0.0.1:8000:8000
    volumes:
      - ./data:/data
    depends_on:
      init-data:
        condition: service_completed_successfully
    networks:
      - purrimeter-internal
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
      memlock:
        soft: -1
        hard: -1

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8080:8080"
    networks:
      - purrimeter-internal
    # network_mode: host
    environment:
      - API_ADMIN=${API_ADMIN}
      - SURREAL_ADMIN=${SURREAL_ADMIN}
      - SURREAL_PASS=${SURREAL_PASS}
      - API_ADMIN_PASS=${API_ADMIN_PASS}
      - LOGGER_USER=${LOGGER_USER}
      - LOGGER_PASS=${LOGGER_PASS}
      - JWT_SECRET=${JWT_SECRET}
      - AGENT_SECRET=${AGENT_SECRET}
    depends_on:
      surrealdb:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 2s
      retries: 2
      start_period: 40s
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
      memlock:
        soft: -1
        hard: -1
    labels:
      - "autoheal=true"  # Enable autoheal for this container

  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=5
      - AUTOHEAL_START_PERIOD=30
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - purrimeter-internal

networks:
  purrimeter-internal:
    driver: bridge
    name: "purrimeter-internal"
    driver_opts:
      com.docker.network.bridge.name: purrimeter0
      com.docker.network.driver.mtu: 1500
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"